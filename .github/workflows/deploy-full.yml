name: Deploy SMPN 6 App

on:
  push:
    branches:
      - main

jobs:
  # --------------------------------------------------------
  # TUGAS 1: DEPLOY FRONTEND (REACT)
  # --------------------------------------------------------
  web-deploy:
    name: üöÄ Deploy Frontend
    runs-on: ubuntu-latest
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install Dependencies
        working-directory: ./frontend
        run: npm install

      - name: ‚öôÔ∏è Create .env.production
        working-directory: ./frontend
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_URL_PROD }}" > .env.production

      - name: üèóÔ∏è Build Frontend
        working-directory: ./frontend
        run: npm run build
      
      # Membuat .htaccess agar React Router aman saat refresh page
      - name: üìÑ Create .htaccess manually
        working-directory: ./frontend/dist
        run: |
          cat <<EOF > .htaccess
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-l
            RewriteRule . /index.html [L]
          </IfModule>
          EOF

      - name: üìÇ Upload to Public HTML
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_FTP_USER }}
          password: ${{ secrets.CPANEL_FTP_PASS }}
          local-dir: ./frontend/dist/
          server-dir: ./kokurikuler.smpn6pekalongan.org/
          dangerous-clean-slate: true
          protocol: ftp
          port: 21
          timeout: 300000 # 5 Menit timeout

  # --------------------------------------------------------
  # TUGAS 2: DEPLOY BACKEND (ZIP + UNZIP METHOD)
  # --------------------------------------------------------
  server-deploy:
    name: üöÄ Deploy Backend
    needs: web-deploy
    runs-on: ubuntu-latest
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install semua untuk build, lalu hapus, install hanya production untuk upload
      - name: üì¶ Prepare Backend Files
        working-directory: ./backend
        run: |
          npm install
          npm run build
          rm -rf node_modules
          npm install --production --omit=dev

      # Membuat .htaccess konfigurasi CloudLinux Passenger
      - name: üìÑ Create .htaccess
        working-directory: ./backend
        run: |
          cat <<EOF > .htaccess
          # DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION BEGIN
          PassengerAppRoot "/home/smpnpeka/backendkokurikuler.smpn6pekalongan.org"
          PassengerBaseURI "/"
          PassengerNodejs "/home/smpnpeka/nodevenv/backendkokurikuler.smpn6pekalongan.org/20/bin/node"
          PassengerAppType node
          PassengerStartupFile dist/index.js
          # DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION END
          
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
          EOF

      # Membuat script PHP untuk Unzip di Server secara otomatis
      - name: üêò Create Unzip Script
        working-directory: ./backend
        run: |
          cat <<EOF > unzip_backend.php
          <?php
          \$zipFile = 'backend_update.zip';
          
          if (file_exists(\$zipFile)) {
              \$zip = new ZipArchive;
              if (\$zip->open(\$zipFile) === TRUE) {
                  \$zip->extractTo('./');
                  \$zip->close();
                  echo "Sukses: File berhasil di-unzip.<br>";
                  
                  // Hapus file zip setelah selesai
                  unlink(\$zipFile);
                  echo "Info: File zip dihapus.<br>";
                  
                  // Restart Node.js App (CloudLinux Passenger)
                  if (!is_dir('tmp')) { mkdir('tmp'); }
                  file_put_contents('tmp/restart.txt', time());
                  echo "Sukses: Aplikasi direstart (tmp/restart.txt touched).";
              } else {
                  http_response_code(500);
                  echo "Gagal: Tidak bisa membuka file zip.";
              }
          } else {
              http_response_code(404);
              echo "Gagal: File zip tidak ditemukan.";
          }
          ?>
          EOF

      - name: üóúÔ∏è Zip Files (Code + Node Modules + Config)
        working-directory: ./backend
        run: |
          # Masukkan dist, node_modules, package.json, dan file config ke dalam ZIP
          zip -r -q backend_update.zip dist node_modules package.json .htaccess unzip_backend.php

      - name: üìÇ Upload ZIP to Server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_FTP_USER }}
          password: ${{ secrets.CPANEL_FTP_PASS }}
          local-dir: ./backend/
          # Kita hanya upload satu file ZIP, jadi filter ini penting agar tidak upload folder src/dll
          include-only: "^backend_update.zip$"
          server-dir: ./backendkokurikuler.smpn6pekalongan.org/
          # Jangan hapus file lama dulu, biarkan unzip yang menimpa
          dangerous-clean-slate: false
          protocol: ftp
          port: 21
          timeout: 600000 # 10 Menit timeout (karena file zip besar berisi node_modules)

      - name: üîì Execute Unzip on Server
        run: |
          echo "Memicu proses unzip di server..."
          # Menggunakan curl untuk menjalankan script PHP yang baru saja diupload
          curl -L --fail https://backendkokurikuler.smpn6pekalongan.org/unzip_backend.php
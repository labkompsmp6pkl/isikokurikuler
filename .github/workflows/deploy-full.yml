name: Deploy SMPN 6 App

on:
  push:
    branches:
      - main

jobs:
  # --------------------------------------------------------
  # TUGAS 1: DEPLOY FRONTEND (ISOLATION ZIP METHOD)
  # --------------------------------------------------------
  web-deploy:
    name: ğŸš€ Deploy Frontend (Fix Stuck)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Build Frontend
        working-directory: ./frontend
        run: |
          npm install
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_URL_PROD }}" > .env.production
          npm run build

      # 1. BUAT FOLDER KHUSUS UNTUK UPLOAD (ISOLASI)
      - name: ğŸ“ Prepare Upload Directory
        run: mkdir final_frontend_upload

      # 2. BUAT .HTACCESS & ZIP DI DALAM DIST
      - name: ğŸ“„ Create .htaccess & Zip
        working-directory: ./frontend/dist
        run: |
          # Buat htaccess
          echo "<IfModule mod_rewrite.c>" > .htaccess
          echo "RewriteEngine On" >> .htaccess
          echo "RewriteBase /" >> .htaccess
          echo "RewriteRule ^index\.html$ - [L]" >> .htaccess
          echo "RewriteCond %{REQUEST_FILENAME} !-f" >> .htaccess
          echo "RewriteCond %{REQUEST_FILENAME} !-d" >> .htaccess
          echo "RewriteCond %{REQUEST_FILENAME} !-l" >> .htaccess
          echo "RewriteRule . /index.html [L]" >> .htaccess
          echo "</IfModule>" >> .htaccess
          
          # Zip semua isi folder dist ke file frontend.zip
          zip -r -q frontend.zip .

      # 3. PINDAHKAN ZIP KE FOLDER ISOLASI & BUAT SCRIPT PHP DISANA
      - name: ğŸ˜ Setup Isolation Folder
        run: |
          # Pindahkan zip dari dist ke folder isolasi
          mv ./frontend/dist/frontend.zip ./final_frontend_upload/
          
          # Masuk ke folder isolasi untuk buat script php
          cd final_frontend_upload
          
          # Buat script unzip
          cat <<EOF > unzip_frontend.php
          <?php
          \$zipFile = 'frontend.zip';
          if (file_exists(\$zipFile)) {
              \$zip = new ZipArchive;
              if (\$zip->open(\$zipFile) === TRUE) {
                  \$zip->extractTo('./');
                  \$zip->close();
                  echo "SUCCESS_UNZIP";
                  unlink(\$zipFile); // Hapus zip
                  unlink(__FILE__); // Hapus script ini
              } else {
                  http_response_code(500); echo "FAIL_OPEN_ZIP";
              }
          } else { http_response_code(404); echo "ZIP_NOT_FOUND"; }
          ?>
          EOF

      # 4. UPLOAD FOLDER ISOLASI (HANYA BERISI 2 FILE: ZIP & PHP)
      - name: ğŸ“‚ Upload ZIP Only
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_FTP_USER }}
          password: ${{ secrets.CPANEL_FTP_PASS }}
          # Perhatikan ini: Kita upload folder isolasi, BUKAN folder dist
          local-dir: ./final_frontend_upload/
          server-dir: ./kokurikuler.smpn6pekalongan.org/
          dangerous-clean-slate: false
          protocol: ftp
          port: 21
          timeout: 600000

      # 5. EKSEKUSI UNZIP
      - name: ğŸ”“ Trigger Unzip on Server
        run: |
          echo "Unzipping..."
          curl -L --fail https://kokurikuler.smpn6pekalongan.org/unzip_frontend.php

  # --------------------------------------------------------
  # TUGAS 2: DEPLOY BACKEND (TETAP SAMA SEPERTI SEBELUMNYA)
  # --------------------------------------------------------
  server-deploy:
    name: ğŸš€ Deploy Backend
    needs: web-deploy
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Build Backend
        working-directory: ./backend
        run: |
          npm install
          npm run build
          rm -rf node_modules
          npm install --production --omit=dev

      - name: ğŸ“„ Create .htaccess & Config
        working-directory: ./backend
        run: |
          cat <<EOF > .htaccess
          # DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION BEGIN
          PassengerAppRoot "/home/smpnpeka/backendkokurikuler.smpn6pekalongan.org"
          PassengerBaseURI "/"
          PassengerNodejs "/home/smpnpeka/nodevenv/backendkokurikuler.smpn6pekalongan.org/20/bin/node"
          PassengerAppType node
          PassengerStartupFile dist/index.js
          # DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION END
          
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
          EOF

      - name: ğŸ“‚ Prepare Isolation for Backend
        run: mkdir final_backend_upload

      - name: ğŸ—œï¸ Zip Backend & Script
        working-directory: ./backend
        run: |
          # Zip backend
          zip -r -q backend.zip dist node_modules package.json .htaccess
          
          # Pindahkan ke folder isolasi
          mv backend.zip ../final_backend_upload/

      - name: ğŸ˜ Create Backend Unzip Script
        working-directory: ./final_backend_upload
        run: |
          cat <<EOF > unzip_backend.php
          <?php
          \$zipFile = 'backend.zip';
          if (file_exists(\$zipFile)) {
              \$zip = new ZipArchive;
              if (\$zip->open(\$zipFile) === TRUE) {
                  \$zip->extractTo('./');
                  \$zip->close();
                  unlink(\$zipFile);
                  if (!is_dir('tmp')) { mkdir('tmp'); }
                  file_put_contents('tmp/restart.txt', time());
                  echo "SUCCESS_BACKEND_UPDATE";
                  unlink(__FILE__);
              } else { http_response_code(500); echo "FAIL"; }
          } else { http_response_code(404); echo "NOT_FOUND"; }
          ?>
          EOF

      - name: ğŸ“‚ Upload Backend ZIP Only
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_FTP_USER }}
          password: ${{ secrets.CPANEL_FTP_PASS }}
          local-dir: ./final_backend_upload/
          server-dir: ./backendkokurikuler.smpn6pekalongan.org/
          dangerous-clean-slate: false
          protocol: ftp
          port: 21
          timeout: 600000

      - name: ğŸ”“ Execute Backend Unzip
        run: curl -L --fail https://backendkokurikuler.smpn6pekalongan.org/unzip_backend.php
name: Deploy SMPN 6 App

on:
  push:
    branches:
      - main

jobs:
  # --------------------------------------------------------
  # TUGAS 1: DEPLOY FRONTEND (REACT)
  # --------------------------------------------------------
  web-deploy:
    name: üöÄ Deploy Frontend
    runs-on: ubuntu-latest
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install Dependencies (Client)
        working-directory: ./frontend
        run: npm install
      
      # --- [BAGIAN BARU] MEMBUAT .ENV.PRODUCTION OTOMATIS ---
      - name: ‚öôÔ∏è Create .env.production
        working-directory: ./frontend
        run: |
          # Kita buat file .env.production yang berisi URL Backend cPanel
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_URL_PROD }}" > .env.production
          echo "VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }}" >> .env.production
          # Cek isinya (Opsional, untuk debug)
          cat .env.production

      - name: üèóÔ∏è Build Frontend
        working-directory: ./frontend
        run: npm run build
      
      - name: üìÑ Create .htaccess manually
        run: |
          cd frontend/dist
          echo "<IfModule mod_rewrite.c>" > .htaccess
          echo "  RewriteEngine On" >> .htaccess
          echo "  RewriteBase /" >> .htaccess
          echo "  RewriteRule ^index\.html$ - [L]" >> .htaccess
          echo "  RewriteCond %{REQUEST_FILENAME} !-f" >> .htaccess
          echo "  RewriteCond %{REQUEST_FILENAME} !-d" >> .htaccess
          echo "  RewriteCond %{REQUEST_FILENAME} !-l" >> .htaccess
          echo "  RewriteRule . /index.html [L]" >> .htaccess
          echo "</IfModule>" >> .htaccess

      - name: üìÇ Upload to Public HTML
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_FTP_USER }}
          password: ${{ secrets.CPANEL_FTP_PASS }}
          local-dir: ./frontend/dist/
          server-dir: ./kokurikuler.smpn6pekalongan.org/ 
          dangerous-clean-slate: true 
          protocol: ftp
          port: 21
          security: loose
          
# --------------------------------------------------------
  # TUGAS 2: DEPLOY BACKEND (DENGAN AUTO-GENERATE HTACCESS)
  # --------------------------------------------------------
  server-deploy:
    name: üöÄ Deploy Backend (Final & Complete)
    needs: web-deploy
    runs-on: ubuntu-latest
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Build Backend
        working-directory: ./backend
        run: |
          npm install
          npm run build
          rm -rf node_modules
          npm install --production

      # --- [BAGIAN PENTING] MEMBUAT .HTACCESS OTOMATIS ---
      - name: üìÑ Create .htaccess from Secret Config
        working-directory: ./backend
        run: |
          # Kita gunakan 'cat <<EOF' agar rapi untuk banyak baris
          cat <<EOF > .htaccess
          # DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION BEGIN
          PassengerAppRoot "/home/smpnpeka/backendkokurikuler.smpn6pekalongan.org"
          PassengerBaseURI "/"
          PassengerNodejs "/home/smpnpeka/nodevenv/backendkokurikuler.smpn6pekalongan.org/20/bin/node"
          PassengerAppType node
          PassengerStartupFile dist/index.js
          # DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION END

          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
          EOF
          
          # ‚ö†Ô∏è PENTING: 
          # Pastikan path "/home/smpnpeka/..." di atas SESUAI dengan 
          # yang ada di file .htaccess cPanel Anda saat ini.
          
      - name: üóúÔ∏è Bungkus ZIP (Sertakan .htaccess)
        working-directory: ./backend
        run: |
          # Perhatikan: Kita MENAMBAHKAN .htaccess ke dalam perintah zip
          zip -r backend_update.zip dist package.json package-lock.json .htaccess
          
          mkdir ../final_upload
          mv backend_update.zip ../final_upload/
          cp unzip_backend.php ../final_upload/

      - name: üìÇ Upload Folder Isolasi
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_FTP_USER }}
          password: ${{ secrets.CPANEL_FTP_PASS }}
          local-dir: ./final_upload/
          server-dir: ./backendkokurikuler.smpn6pekalongan.org/
          protocol: ftp
          port: 21
          security: loose
          
      - name: üîì Eksekusi Unzip
        run: |
          echo "Memanggil script unzip..."
          # Gunakan HTTPS agar aman
          curl -L https://backendkokurikuler.smpn6pekalongan.org/unzip_backend.php
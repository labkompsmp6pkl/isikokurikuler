name: Deploy SMPN 6 App

on:
  push:
    branches:
      - main

jobs:
  # --------------------------------------------------------
  # TUGAS 1: DEPLOY FRONTEND (METODE ZIP - ANTI MANDEK)
  # --------------------------------------------------------
  web-deploy:
    name: ğŸš€ Deploy Frontend (ZIP Method)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install & Build Frontend
        working-directory: ./frontend
        run: |
          npm install
          # Buat .env production
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_URL_PROD }}" > .env.production
          npm run build

      # Membuat .htaccess (Penting untuk React Router)
      - name: ğŸ“„ Create .htaccess
        working-directory: ./frontend/dist
        run: |
          cat <<EOF > .htaccess
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-l
            RewriteRule . /index.html [L]
          </IfModule>
          EOF

      # Membuat script Unzip untuk Frontend
      - name: ğŸ˜ Create Frontend Unzip Script
        working-directory: ./frontend/dist
        run: |
          cat <<EOF > unzip_frontend.php
          <?php
          \$zipFile = 'frontend_app.zip';
          if (file_exists(\$zipFile)) {
              \$zip = new ZipArchive;
              if (\$zip->open(\$zipFile) === TRUE) {
                  \$zip->extractTo('./');
                  \$zip->close();
                  echo "Frontend Sukses Di-unzip.";
                  unlink(\$zipFile); // Hapus zip biar bersih
                  unlink(__FILE__); // Hapus script ini sendiri (self-destruct)
              } else {
                  http_response_code(500); echo "Gagal unzip.";
              }
          } else { http_response_code(404); echo "Zip tidak ada."; }
          ?>
          EOF

      # Bungkus hasil build jadi ZIP
      - name: ğŸ—œï¸ Zip Frontend Assets
        working-directory: ./frontend/dist
        run: zip -r -q frontend_app.zip .

      # Upload hanya 1 file ZIP + Script PHP (Cepat & Stabil)
      - name: ğŸ“‚ Upload ZIP to Public HTML
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_FTP_USER }}
          password: ${{ secrets.CPANEL_FTP_PASS }}
          local-dir: ./frontend/dist/
          server-dir: ./kokurikuler.smpn6pekalongan.org/
          # Filter: Hanya upload zip dan script php
          include-only: "^(frontend_app.zip|unzip_frontend.php)$"
          dangerous-clean-slate: false
          protocol: ftp
          port: 21
          timeout: 300000

      # Eksekusi Unzip di Server
      - name: ğŸ”“ Execute Unzip
        run: curl -L --fail https://kokurikuler.smpn6pekalongan.org/unzip_frontend.php

  # --------------------------------------------------------
  # TUGAS 2: DEPLOY BACKEND (METODE ZIP - SUDAH BENAR)
  # --------------------------------------------------------
  server-deploy:
    name: ğŸš€ Deploy Backend (ZIP Method)
    needs: web-deploy
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Build Backend
        working-directory: ./backend
        run: |
          npm install
          npm run build
          rm -rf node_modules
          npm install --production --omit=dev

      - name: ğŸ“„ Create .htaccess for Passenger
        working-directory: ./backend
        run: |
          cat <<EOF > .htaccess
          # DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION BEGIN
          PassengerAppRoot "/home/smpnpeka/backendkokurikuler.smpn6pekalongan.org"
          PassengerBaseURI "/"
          PassengerNodejs "/home/smpnpeka/nodevenv/backendkokurikuler.smpn6pekalongan.org/20/bin/node"
          PassengerAppType node
          PassengerStartupFile dist/index.js
          # DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION END
          
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
          EOF

      - name: ğŸ˜ Create Backend Unzip Script
        working-directory: ./backend
        run: |
          cat <<EOF > unzip_backend.php
          <?php
          \$zipFile = 'backend_update.zip';
          if (file_exists(\$zipFile)) {
              \$zip = new ZipArchive;
              if (\$zip->open(\$zipFile) === TRUE) {
                  \$zip->extractTo('./');
                  \$zip->close();
                  unlink(\$zipFile);
                  
                  // Restart App
                  if (!is_dir('tmp')) { mkdir('tmp'); }
                  file_put_contents('tmp/restart.txt', time());
                  echo "Backend Sukses Update & Restart.";
                  unlink(__FILE__);
              } else { http_response_code(500); echo "Gagal unzip."; }
          } else { http_response_code(404); echo "Zip tidak ada."; }
          ?>
          EOF

      - name: ğŸ—œï¸ Zip Backend
        working-directory: ./backend
        run: zip -r -q backend_update.zip dist node_modules package.json .htaccess unzip_backend.php

      - name: ğŸ“‚ Upload ZIP to Server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_FTP_USER }}
          password: ${{ secrets.CPANEL_FTP_PASS }}
          local-dir: ./backend/
          include-only: "^backend_update.zip$"
          server-dir: ./backendkokurikuler.smpn6pekalongan.org/
          dangerous-clean-slate: false
          protocol: ftp
          port: 21
          timeout: 600000

      - name: ğŸ”“ Execute Backend Unzip
        run: curl -L --fail https://backendkokurikuler.smpn6pekalongan.org/unzip_backend.php